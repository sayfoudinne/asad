{% extends "core/base.html" %}
{% block title %}Leerling{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h1 class="h3 mb-1">{{ student.first_name }} {{ student.last_name }}</h1>
    <div class="text-muted">Klas: <span class="badge text-bg-secondary">{{ student.school_class.name }}</span></div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-primary" href="{% url 'violation_create_for_student' student.id %}">+ Overtreding</a>
    <a class="btn btn-outline-secondary" href="{% url 'students_list' %}">Terug</a>
  </div>
</div>

<!-- Filter Sectie -->
<div class="card shadow-sm mb-4">
  <div class="card-header">
    <button class="btn btn-link text-decoration-none text-white p-0 w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="{% if has_active_filters %}true{% else %}false{% endif %}" aria-controls="filterCollapse">
      <h5 class="mb-0 d-flex justify-content-between align-items-center">
        <span>üîç Filters</span>
        {% if has_active_filters %}
          <span class="badge bg-danger">Actief</span>
        {% endif %}
      </h5>
    </button>
  </div>
  <div class="collapse {% if has_active_filters %}show{% endif %}" id="filterCollapse">
    <div class="card-body">
      <form method="get" action="{% url 'student_detail' student.id %}" class="row g-3">
        <div class="col-12 col-md-3">
          <label for="{{ filter_form.date_from.id_for_label }}" class="form-label">{{ filter_form.date_from.label }}</label>
          {{ filter_form.date_from }}
        </div>
        <div class="col-12 col-md-3">
          <label for="{{ filter_form.date_to.id_for_label }}" class="form-label">{{ filter_form.date_to.label }}</label>
          {{ filter_form.date_to }}
        </div>
        <div class="col-12 col-md-3">
          <label for="{{ filter_form.violation_type.id_for_label }}" class="form-label">{{ filter_form.violation_type.label }}</label>
          {{ filter_form.violation_type }}
        </div>
        <div class="col-12 col-md-3">
          <label for="{{ filter_form.severity.id_for_label }}" class="form-label">{{ filter_form.severity.label }}</label>
          {{ filter_form.severity }}
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Filter toepassen</button>
          <a href="{% url 'student_detail' student.id %}" class="btn btn-outline-secondary">Reset filters</a>
          {% if has_active_filters %}
            <span class="ms-2 text-muted">
              <small>Filters zijn actief ‚Äì overtredingen worden gefilterd weergegeven</small>
            </span>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-white">
    <strong>Overtredingen</strong>
    {% if has_active_filters %}
      <span class="badge bg-danger ms-2">Gefilterd</span>
    {% endif %}
  </div>

  <div class="table-responsive">
    <table class="table table-hover mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th>Overtreding</th>
          <th>Zwaarte</th>
          <th>Datum/tijd</th>
          <th>Opmerkingen</th>
          <th>Voorgesteld</th>
          <th>Definitief</th>
          <th class="text-end">Acties</th>
        </tr>
      </thead>
      <tbody>
        {% for v in violations %}
          <tr>
            <td><strong>{{ v.violation_type.name }}</strong></td>
            <td>
              {% with severity=v.get_severity %}
                {% for i in "12345" %}
                  <span class="badge {% if forloop.counter <= severity %}bg-danger{% else %}bg-secondary{% endif %}">
                    {{ forloop.counter }}
                  </span>
                {% endfor %}
                {% if v.severity %}
                  <small class="text-muted ms-1">(aangepast)</small>
                {% endif %}
              {% endwith %}
            </td>
            <td class="text-muted">{{ v.created_at }}</td>
            <td>{{ v.amount_text|default:"-" }}</td>
            <td>{{ v.proposed_sanction|default:"-" }}</td>
            <td>{{ v.final_sanction_text|default:"-" }}</td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary" href="{% url 'violation_edit' v.id %}">Wijzig</a>
              <a class="btn btn-sm btn-outline-danger" href="{% url 'violation_delete' v.id %}">Verwijder</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="7" class="text-muted">Nog geen overtredingen.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
